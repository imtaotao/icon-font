const fs = require('fs')
const opn = require('opn')
const path = require('path')

function genHTMLTemplate (unitText, cssText, additional) {
  return '<!DOCTYPE html>\n' +
  '<html lang="en">\n' +
  '<head>\n' +
  '  <meta charset="UTF-8">\n' +
  '  <meta name="description" content="An Icon Font Generated By IconFont">\n' +
  '  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
  '  <title>IconFont Demo</title>\n' +
  '  <style>\n' +
      cssText + '\n' +
      additional + '\n' +
  '  </style>\n' +
  '</head>\n' +
  '<body>\n' +
  unitText +
  '</body>\n' +
  '</html>'
}

function genUnitText (map) {
  let res = ''
  const unit = name => `  <div>${name} <p class="icon-${name}"></p></div>\n`
  
  map.forEach((icon, i) => {
    res += unit(icon.name)
  })
  return res
}

function additionalStyles () {
  return 'div {\n' +
  '  float: left;\n' +
  '  margin: 10px;\n' +
  '  padding: 10px;\n' +
  '  font-size: 12px;\n' +
  '  border: 1px solid #f1f1f1;\n' +
  '}\n' +

  'p {\n' + 
  '  margin: 10px;\n' +
  '}'
}

function addWrap (cssText) {
  const lines = cssText.split('\n').map(val => '    ' + val)
  return lines.join('\n')
}

function createFile (template, { to, open }, filename) {
  const url = path.resolve(to, filename)
  const stream = fs.createWriteStream(url)

  stream.end(template, () => {
    // 打开 demo.html
    open && opn(url)
  })
}

module.exports = function genTemplate (map, opts, cssText) {
  const unitText = genUnitText(map)
  const additionalText = addWrap(additionalStyles())
  const template = genHTMLTemplate(unitText, addWrap(cssText), additionalText)

  createFile(template, opts, 'demo.html')
}